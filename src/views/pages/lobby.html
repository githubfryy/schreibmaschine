<div class="lobby-container" 
     x-data="lobbyData()" 
     x-init="initLobby()">
  
  <div class="header">
    <div class="workshop">{{workshop.name}}</div>
    <h1 class="group-name">{{writing_group.name}}</h1>
    {{#if writing_group.description}}
    <div class="description">{{writing_group.description}}</div>
    {{/if}}
  </div>
  
  <div class="info">
    <h2>👋 Willkommen im Vorraum</h2>
    <p>Wähle deinen Namen aus, um der Schreibgruppe beizutreten:</p>
  </div>
  
  <!-- Loading/Error Messages -->
  <div x-show="isLoading" class="loading-message">
    🔄 Anmeldung läuft...
  </div>
  
  <div x-show="errorMessage" class="error-message" x-text="errorMessage"></div>
  
  <div x-show="multiDeviceMessage" class="multi-device-message">
    <p>💻 Du bist bereits auf einem anderen Gerät angemeldet.</p>
    <p>Du kannst trotzdem fortfahren - beide Geräte bleiben verbunden.</p>
  </div>
  
  <!-- Participants List -->
  <div class="participants" x-show="!isLoading">
    {{#each participants}}
    <button class="participant-btn" 
            data-participant-id="{{id}}" 
            data-role="{{role}}"
            x-on:click="selectParticipant('{{id}}', '{{display_name}}', '{{role}}')"
            :disabled="isLoading">
      {{display_name}}{{#if (eq role 'teamer')}} 👑{{/if}}
    </button>
    {{/each}}
  </div>
  
  <div class="info">
    <p><strong>💡 Hinweis:</strong> Du kannst dich auch von anderen Geräten (Tablet, Handy) mit demselben Namen anmelden.</p>
    <p><strong>Status:</strong> {{#if is_active}}🟢 Gruppe ist aktiv{{else}}🟡 Gruppe wird vorbereitet{{/if}}</p>
  </div>
  
  <div class="urls">
    <strong>📎 URLs zum Teilen:</strong>
    <div class="url">Direkt: {{urls.full_semantic_url}}</div>
    <div class="url">Kurz: {{urls.short_url}}</div>
  </div>
</div>

<script>
// Alpine.js component for lobby functionality
document.addEventListener('alpine:init', () => {
  Alpine.data('lobbyData', () => ({
    // State
    isLoading: false,
    errorMessage: '',
    multiDeviceMessage: false,
    groupId: '{{workshop_group.id}}',
    
    // Initialize lobby
    async initLobby() {
      // Check if already authenticated
      try {
        const session = await SchreibmaschineAuth.checkSession();
        if (session.authenticated && session.workshopGroup?.id === this.groupId) {
          // Already logged in to this group, redirect to group room
          window.location.href = '{{urls.full_semantic_url}}';
        }
      } catch (error) {
        console.log('No existing session found');
      }
    },
    
    // Handle participant selection
    async selectParticipant(participantId, displayName, role) {
      if (this.isLoading) return;
      
      this.isLoading = true;
      this.errorMessage = '';
      this.multiDeviceMessage = false;
      
      try {
        // Use new session-based login
        const result = await SchreibmaschineAuth.loginToGroup(participantId, this.groupId);
        
        if (result.success) {
          // Show multi-device message if detected
          if (result.isMultiDevice) {
            this.multiDeviceMessage = true;
            // Still redirect after a short delay
            setTimeout(() => {
              window.location.href = '{{urls.full_semantic_url}}';
            }, 2000);
          } else {
            // Immediate redirect for new sessions
            window.location.href = '{{urls.full_semantic_url}}';
          }
        } else {
          this.errorMessage = result.error || 'Anmeldung fehlgeschlagen';
          this.isLoading = false;
        }
      } catch (error) {
        console.error('Login error:', error);
        this.errorMessage = 'Verbindungsfehler. Bitte versuche es nochmal.';
        this.isLoading = false;
      }
    }
  }));
});
</script>